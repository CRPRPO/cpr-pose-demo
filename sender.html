
<!DOCTYPE html>
<html>
<head>
  <title>CPR Pose Detection</title>
  <style>
    video, canvas {
      position: absolute;
      left: 0;
      top: 0;
    }
    #sideLabel {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 48px;
      color: red;
      font-weight: bold;
    }
    #rateLabel {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 36px;
      color: green;
      background: white;
      padding: 8px;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <video id="video" width="640" height="480" autoplay muted playsinline></video>
  <canvas id="output" width="640" height="480"></canvas>
  <div id="sideLabel"></div>
  <div id="rateLabel">偵測中...</div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('output');
    const ctx = canvas.getContext('2d');
    const sideLabel = document.getElementById('sideLabel');
    const rateLabel = document.getElementById('rateLabel');

    let previousY = null;
    let timestamps = [];

    const pose = new Pose.Pose({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
    });

    pose.setOptions({
      modelComplexity: 1,
      smoothLandmarks: true,
      enableSegmentation: false,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    pose.onResults(results => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

      if (!results.poseLandmarks) return;

      const lm = results.poseLandmarks;

      const left = [lm[11], lm[13], lm[15], lm[23]]; // shoulder, elbow, wrist, hip
      const right = [lm[12], lm[14], lm[16], lm[24]];

      const leftVisible = left.every(p => p.visibility > 0.5);
      const rightVisible = right.every(p => p.visibility > 0.5);

      let side = '';
      let points = [];

      if (leftVisible && (!rightVisible || left[0].x < right[0].x)) {
        side = '左手';
        points = [left[2], left[0], left[3]]; // wrist, shoulder, hip
      } else if (rightVisible) {
        side = '右手';
        points = [right[2], right[0], right[3]];
      } else {
        side = '';
      }

      if (points.length > 0) {
        sideLabel.textContent = side;

        ctx.fillStyle = 'red';
        ctx.strokeStyle = 'blue';
        ctx.lineWidth = 4;

        points.forEach(p => {
          ctx.beginPath();
          ctx.arc(p.x * canvas.width, p.y * canvas.height, 8, 0, 2 * Math.PI);
          ctx.fill();
        });

        // draw line: wrist -> shoulder -> hip
        ctx.beginPath();
        ctx.moveTo(points[0].x * canvas.width, points[0].y * canvas.height);
        ctx.lineTo(points[1].x * canvas.width, points[1].y * canvas.height);
        ctx.lineTo(points[2].x * canvas.width, points[2].y * canvas.height);
        ctx.stroke();

        // show labels
        ctx.font = '20px Arial';
        ctx.fillStyle = 'black';
        ctx.fillText("手腕", points[0].x * canvas.width + 10, points[0].y * canvas.height);
        ctx.fillText("肩膀", points[1].x * canvas.width + 10, points[1].y * canvas.height);
        ctx.fillText("髖關節", points[2].x * canvas.width + 10, points[2].y * canvas.height);

        // calculate rate
        const shoulderY = points[1].y;
        const hipY = points[2].y;
        const diff = shoulderY - hipY;

        const now = performance.now();
        if (previousY !== null && diff > 0.05 && previousY - shoulderY > 0.015) {
          timestamps.push(now);
          if (timestamps.length > 10) timestamps.shift();
        }
        previousY = shoulderY;

        // calculate CPR rate
        const cutoff = now - 2000;
        const recent = timestamps.filter(t => t > cutoff);
        const rate = Math.round((recent.length / 2) * 60);

        if (rate < 80 || rate > 130) {
          rateLabel.style.color = 'red';
        } else if (rate >= 95 && rate <= 125) {
          rateLabel.style.color = 'green';
        } else {
          rateLabel.style.color = 'orange';
        }

        rateLabel.textContent = `CPR速率：${rate} 下/分鐘`;
      }
    });

    async function start() {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } },
        audio: false
      });
      video.srcObject = stream;

      const camera = new Camera.Camera(video, {
        onFrame: async () => {
          await pose.send({ image: video });
        },
        width: 640,
        height: 480
      });
      camera.start();
    }

    start();
  </script>
</body>
</html>
