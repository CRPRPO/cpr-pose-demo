<!DOCTYPE html>
<html>
<head>
  <title>CPR 偵測系統 V5.4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: black;
    }
    video, canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
    }
    video {
      transform: scaleX(-1); /* 鏡像影片 */
      z-index: 0;
    }
    canvas {
      z-index: 1;
    }
    #startBtn {
      position: absolute;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5em;
      padding: 20px 30px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      z-index: 2;
    }
  </style>
</head>
<body>
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>
  <button id="startBtn">開啟鏡頭</button>

<!-- MediaPipe Pose + Camera Utilities（CDN） -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
  // 檢查外部套件是否載入
  if (!window.Pose || !window.Camera) {
    console.error("MediaPipe 尚未載入");
  }

  const video   = document.getElementById("video");
  const canvas  = document.getElementById("canvas");
  const ctx     = canvas.getContext("2d");
  const startBtn= document.getElementById("startBtn");

  // ---- MediaPipe 索引 ----
  const L_SHOULDER = 11, R_SHOULDER = 12;
  const L_ELBOW    = 13, R_ELBOW    = 14;
  const L_WRIST    = 15, R_WRIST    = 16;

  // ---- 平滑參數 ----
  const smoothStore = {};
  const SMOOTH_ALPHA = 0.6;
  function smoothPoint(idx, raw, w, h) {
    if (!raw) return null;
    const x = raw.x * w, y = raw.y * h;
    const prev = smoothStore[idx];
    smoothStore[idx] = prev
      ? { x: SMOOTH_ALPHA * prev.x + (1 - SMOOTH_ALPHA) * x,
          y: SMOOTH_ALPHA * prev.y + (1 - SMOOTH_ALPHA) * y }
      : { x, y };
    return smoothStore[idx];
  }

  function drawCircle(p, r, color) {
    if (!p) return;
    ctx.beginPath();
    ctx.arc(p.x, p.y, r, 0, Math.PI * 2);
    ctx.fillStyle = color;
    ctx.fill();
  }
  function drawLine(a, b, width, color) {
    if (!a || !b) return;
    ctx.beginPath();
    ctx.moveTo(a.x, a.y);
    ctx.lineTo(b.x, b.y);
    ctx.lineWidth = width;
    ctx.strokeStyle = color;
    ctx.stroke();
  }

  let pose = null;
  let camera = null;

  async function initPose() {
    pose = new Pose.Pose({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`,
    });
    pose.setOptions({
      modelComplexity: 0,
      smoothLandmarks: true,
      enableSegmentation: false,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5,
    });
    pose.onResults(onPoseResults);

    // Camera Utils 會自己開鏡與取流
    camera = new Camera(video, {
      onFrame: async () => { await pose.send({ image: video }); },
      width: 640,
      height: 480,
    });

    // 等到 video 有尺寸後把 canvas 同步
    video.addEventListener("loadeddata", () => {
      if (video.videoWidth && video.videoHeight) {
        canvas.width  = video.videoWidth;
        canvas.height = video.videoHeight;
      }
    }, { once: true });

    await camera.start();
  }

  function onPoseResults(results) {
    const landmarks = results.poseLandmarks;
    if (!landmarks) return;

    const w = canvas.width  = video.videoWidth  || canvas.width;
    const h = canvas.height = video.videoHeight || canvas.height;

    ctx.save();
    ctx.clearRect(0, 0, w, h);

    // 鏡像座標，和你的鏡像影片一致
    ctx.translate(w, 0);
    ctx.scale(-1, 1);

    const ls = smoothPoint(L_SHOULDER, landmarks[L_SHOULDER], w, h);
    const rs = smoothPoint(R_SHOULDER, landmarks[R_SHOULDER], w, h);
    const le = smoothPoint(L_ELBOW,    landmarks[L_ELBOW],    w, h);
    const re = smoothPoint(R_ELBOW,    landmarks[R_ELBOW],    w, h);
    const lw = smoothPoint(L_WRIST,    landmarks[L_WRIST],    w, h);
    const rw = smoothPoint(R_WRIST,    landmarks[R_WRIST],    w, h);

    // 點
    drawCircle(ls, 6, "#00BFFF");
    drawCircle(rs, 6, "#00BFFF");
    drawCircle(le, 5, "#FF4D4F");
    drawCircle(re, 5, "#FF4D4F");
    drawCircle(lw, 5, "#FF4D4F");
    drawCircle(rw, 5, "#FF4D4F");

    // 線：肩膀藍、手臂紅
    drawLine(ls, rs, 6, "#1E90FF");
    drawLine(ls, le, 6, "#FF3333"); drawLine(le, lw, 6, "#FF3333");
    drawLine(rs, re, 6, "#FF3333"); drawLine(re, rw, 6, "#FF3333");

    ctx.restore();

    // 這裡畫非鏡像 HUD（若有）
    // ctx.fillStyle = "#fff";
    // ctx.font = "bold 28px sans-serif";
    // ctx.fillText("即時速率：xxx 次/分", 20, 40);
  }

  // 只做一件事：按下去啟動 Pose/Camera
  startBtn.addEventListener("click", async () => {
    try {
      await initPose();
      startBtn.style.display = "none";
    } catch (err) {
      alert("⚠️ 無法啟用鏡頭：" + err.message);
      console.error(err);
    }
  });
</script>

</body>
</html>
