<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>CPR 手腕姿勢偵測 V4.8.5</title>
  <style>
    body {
      margin: 0;
      background: #000;
      overflow: hidden;
      font-family: sans-serif;
    }
    video,
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      transform: scaleX(-1); /* 鏡像 */
      z-index: 0;
    }
    #infoBox {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 24px;
      z-index: 1;
    }
    #messageBox {
      position: absolute;
      top: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 30px;
      border-radius: 10px;
      font-size: 32px;
      z-index: 2;
    }
    #startButton {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 3;
      padding: 20px 40px;
      font-size: 24px;
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    #errorBox {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 0, 0, 0.8);
      color: white;
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 18px;
      z-index: 4;
    }
  </style>
</head>
<body>
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>
  <div id="infoBox">
    <div id="rate">速率: 0 次/分</div>
    <div id="avg">平均速率: 0 次/分</div>
    <div id="count">按壓次數: 0</div>
  </div>
  <div id="messageBox">請雙手交疊</div>
  <button id="startButton">開啟鏡頭</button>
  <div id="errorBox" style="display:none;"></div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const rateText = document.getElementById("rate");
    const avgText = document.getElementById("avg");
    const countText = document.getElementById("count");
    const messageBox = document.getElementById("messageBox");
    const startButton = document.getElementById("startButton");
    const errorBox = document.getElementById("errorBox");

    let timestamps = [],
        lastDirection = null,
        count = 0,
        avgRate = 0,
        baselineY = null,
        camera;

    function updateRateDisplay() {
      const now = Date.now();
      timestamps = timestamps.filter(t => now - t < 60000);
      const rate = timestamps.length;
      avgRate = Math.round(
        timestamps.length > 1
          ? 60000 * (timestamps.length - 1) / (timestamps[timestamps.length - 1] - timestamps[0])
          : 0
      );
      rateText.innerText = `速率: ${rate} 次/分`;
      avgText.innerText = `平均速率: ${avgRate} 次/分`;
      countText.innerText = `按壓次數: ${count}`;
    }

    function drawLine(a, b, color = "red") {
      ctx.beginPath();
      ctx.moveTo(a.x * canvas.width, a.y * canvas.height);
      ctx.lineTo(b.x * canvas.width, b.y * canvas.height);
      ctx.strokeStyle = color;
      ctx.lineWidth = 4;
      ctx.stroke();
    }

    function detectPress(currentY) {
      if (baselineY === null) baselineY = currentY;
      const delta = baselineY - currentY;
      if (Math.abs(delta) > 0.03) {
        const direction = delta > 0 ? "down" : "up";
        if (lastDirection && lastDirection === "down" && direction === "up") {
          timestamps.push(Date.now());
          count++;
          messageBox.innerText = "壓胸中...";
          updateRateDisplay();
        }
        lastDirection = direction;
      }
    }

    const pose = new Pose.Pose({
      locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`
    });
    pose.setOptions({
      modelComplexity: 0,
      smoothLandmarks: true,
      enableSegmentation: false,
      selfieMode: true
    });

    pose.onResults(results => {
      if (!results.poseLandmarks) return;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      ctx.save();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

      const lm = results.poseLandmarks;
      const lShoulder = lm[11];
      const rShoulder = lm[12];
      const lWrist = lm[15];
      const rWrist = lm[16];

      // 畫線
      drawLine(lShoulder, rShoulder, "blue");
      drawLine(lShoulder, lWrist, "red");
      drawLine(rShoulder, rWrist, "red");

      // 採用平均肩高當成Y基準
      const avgY = (lShoulder.y + rShoulder.y) / 2;
      detectPress(avgY);

      ctx.restore();
    });

    startButton.onclick = async () => {
      startButton.style.display = "none";
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
          camera = new Camera(video, {
            onFrame: async () => {
              await pose.send({ image: video });
            },
            width: 640,
            height: 480
          });
          camera.start();
        };
      } catch (err) {
        errorBox.innerText = `⚠️ 鏡頭啟動失敗，錯誤：${err.message}`;
        errorBox.style.display = "block";
      }
    };
  </script>
</body>
</html>
